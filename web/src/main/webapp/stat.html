<!doctype html>
<!--[if lt IE 7]>
<html lang="en-US" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html lang="en-US" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html lang="en-US" class="no-js lt-ie9""> <![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en-US" class="no-js"> <!--<![endif]-->
<head>
    <title>PINPOINT</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="pragma" content="no-cache" />
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css?v=${buildTime}">
    <link rel="stylesheet" href="styles/timer.css?v=${buildTime}">
    <style>
		.starter-template {
		  padding: 40px 15px;
		  text-align: center;
		}
		path {  stroke: #fff; }
		path:hover {  opacity:0.9; }
		rect:hover {  fill:blue; }
		.axis {  font: 10px sans-serif; }
		.legend tr{    border-bottom:1px solid grey; }
		.legend tr:first-child{    border-top:1px solid grey; }
		
		.axis path,
		.axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		}
		
		.x.axis path {  display: none; }
		.legend{
		    display:inline-block;
		    border-collapse: collapse;
		    border-spacing: 0px;
		}
		.legend td{
		    padding:4px 5px;
		    vertical-align:bottom;
		}
		.legendFreq, .legendPerc{
		    align:right;
		    width:50px;
		}
		.main-navbar {
		    position: absolute;
		    margin: 0px 0 0 0;
		    height: 40px;
		    min-height: 40px;
		    background-color: #252a3a;
		    width: 100%;
		    border-radius: 0px;
		}
		.main-navbar .navbar-brand {
			padding: 7px 15px;
		}
		.navbar .beta {
		    position: absolute;
		    left: 138px;
		    top: 12px;
		    font-size: 12px;
		    color: rgb(216, 33, 33);
		    font-family: 'Tahoma', 'Trebuchet MS', 'Verdana';
		}
		.center-middle {
			text-align: center;
			vertical-align: middle !important;
		}
		.loading {
			position:absolute;
			top: 0px;
			width:100%;
			height:100%;
			background: rgba(255, 255, 255, .5);
			text-align:center;
		}		
				
    </style>
</head>
<body>
<div class="navbar main-navbar bs-docs-nav">
    <div class="nav-container">
        <a href="/" class="navbar-brand"><img class="brand" src="/images/logo2.png" width="116" height="18"><div class="beta">beta</div></a>
    </div>
</div>
	<div class="container">
  		<div class="starter-template">
    		<h1>Pinpoint Agent Version Statistic</h1>
    		<div id='dashboard'></div>
  		</div>
  		<div>
			<select class="form-control" id="filter-version">
				<option value="all" selected>All</option>
			</select>
		</div>
  		<table class="table table-striped" id="versionList">
  			<thead>
  				<tr>
  					<th>#</th>
  					<th>Application</th>
  					<th>Agent</th>
  					<th>Version</th>
  				</tr>
  			</thead>
  			<tbody></tbody>
		</table>
	</div><!-- /.container -->
	<div class="loading" id="loadingBar">
		<div class="timer-loader" style="margin-top:40%"></div>
	</div>
	<script src="components/jquery/dist/jquery.js?v=${buildTime}"></script>
    <script src="components/bootstrap/dist/js/bootstrap.min.js?v=${buildTime}"></script>
    <script src="components/d3/d3.min.js?v=${buildTime}"></script>
    <script src="components/handlebars/handlebars.min.js?v=${buildTime}"></script>
    
    <script>
function dashboard(id, fData){
    var barColor = 'steelblue';
    var segColor = d3.scale.category20();
    fData.sort( function( pre, cur ) {
		//return cur.count > pre.count;
		return pre.version > cur.version;
	});
    
    // function to handle pieChart.
    function pieChart(pD){
        var pC ={},    pieDim ={w:250, h: 250};
        pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;
                
        // create svg for pie chart.
        var piesvg = d3.select(id).append("svg")
            .attr("width", pieDim.w).attr("height", pieDim.h).append("g")
            .attr("transform", "translate("+pieDim.w/2+","+pieDim.h/2+")");
        
        // create function to draw the arcs of the pie slices.
        var arc = d3.svg.arc().outerRadius(pieDim.r - 10).innerRadius(0);

        // create a function to compute the pie slice angles.
        var pie = d3.layout.pie().sort(null).value(function(d) { return d.count; });

        // Draw the pie slices.
        piesvg.selectAll("path").data(pie(pD)).enter().append("path").attr("d", arc)
            .each(function(d) { this._current = d; })
            .style("fill", function(d, i) { return segColor(i); });

        // create function to update pie-chart. This will be used by histogram.
        pC.update = function(nD){
            piesvg.selectAll("path").data(pie(nD)).transition().duration(500)
                .attrTween("d", arcTween);
        }        
        // how the intermediate paths should be drawn.
        function arcTween(a) {
            var i = d3.interpolate(this._current, a);
            this._current = i(0);
            return function(t) { return arc(i(t));    };
        }    
        return pC;
    }
    
    // function to handle legend.
    function legend(lD, selected){
        var leg = {};
            
        // create table for legend.
        var legend = d3.select(id).append("table").attr('class','legend');
        var select = legend.append("thead").append("tr").append("td").attr("colspan", 4).append("select").attr("class", "form-control").attr("id", "chart-sort");
        select.append("option").attr("value", "version").text("Version");
        var optionCount = select.append("option");
        optionCount.attr("value", "count").text("Percentage");
        if ( selected == "count" ) {
        	optionCount.attr("selected", "selected");
        }
        
        // create one row per segment.
        var tr = legend.append("tbody").selectAll("tr").data(lD).enter().append("tr");
   
        // create the first column for each segment.
        tr.append("td").append("svg").attr("width", '16').attr("height", '16').append("rect")
            .attr("width", '16').attr("height", '16')
			.attr("fill",function(d, i){ return segColor(i); });
            
        // create the second column for each segment.
        tr.append("td").text(function(d){ return d.version;});

        // create the third column for each segment.
        tr.append("td").attr("class",'legendFreq')
            .text(function(d){ return d3.format(",")(d.count);});

        // create the fourth column for each segment.
        tr.append("td").attr("class",'legendPerc')
            .text(function(d){ return getLegend(d,lD);});

        // Utility function to be used to update the legend.
        leg.update = function(nD){
            // update the data attached to the row elements.
            var l = legend.select("tbody").selectAll("tr").data(nD);

            // update the frequencies.
            l.select(".legendFreq").text(function(d){ return d3.format(",")(d.count);});

            // update the percentage column.
            l.select(".legendPerc").text(function(d){ return getLegend(d,nD);});        
        }
        
        function getLegend(d,aD){ // Utility function to compute percentage.
            return d3.format("%")(d.count/d3.sum(aD.map(function(v){ return v.count; })));
        }

        return leg;
    }
    var pC = pieChart(fData);
   	var leg= legend(fData, "version");
        
   $(id).on("change", "select", function() {
	   var key = $(this).val();
	   fData.sort( function( pre, cur ) {
		   $(id).empty();
		   if ( key == "version") {
			   return pre.version > cur.version;
		   } else {
			   return cur.count > pre.count;
		   }
		});
	   pieChart(fData), // create the pie-chart.
       legend(fData, key);
   });     
}
var parseResultData = function( oData ) {
	var oResult = {};
		
	for (var p in oData ) {
		var a = oData[p];
		for( var j = 0 ; j < a.length ; j++ ) {
			var version = a[j].agentVersion;
			if ( typeof oResult[version] === "undefined" ) {
				oResult[version] = 1;
			} else {
				oResult[version]++;
			}
		}
	}
	var aResult = [];
	for(var ver in oResult ) {
		aResult.push({
			version: ver,
			count: oResult[ver]
		});
	}
	return aResult;
}
var $tbody = $("#versionList tbody"); 
var $selectVersion = $("#filter-version");
var ALL = "all";
var filterTable = function( version ) {
	$tbody.find("td.version").each(function() {
		var $i = $(this);
		if ( version === ALL ) { 
			$i.parent().show();
		} else {
			if ( $i.html() === version ) {
				$i.parent().show();
			} else {
				$i.parent().hide();
			}
		}
	});
}
var compiledTemplate = Handlebars.compile( '<tr><td>{{{index}}}</td><td>{{{appName}}}<td>{{{hostName}}}</td><td class="version">{{{version}}}</td></tr>' );


$.ajax({
	url: "/admin/getAgents.pinpoint?password=admin", 
	method: "GET",
	dataType: "json"
}).done(function(data, textStatue, jqXHR) {
 	var versionData = parseResultData( data );
 	$.each( versionData, function(index, o ) {
 		$selectVersion.append('<option value="' + o.version +'">' + o.version + '</option>');
 	});
 	$selectVersion.on("change", function() {
 		filterTable( $(this).val() );
 	});
 	
 	var totalIndex = 1;
 	for (var appName in data ) {
 		var aApplication = data[appName];
 	 	$.each( aApplication, function( index, o ) {
 	 	 	$tbody.append( compiledTemplate({
 	 	 		index: totalIndex++,
 	 	 		appName: index > 0 ? "" : appName,
 	 	 		hostName: o.hostName,
 	 	 		version: o.agentVersion
 	 	 	}));
 	 	});
 		
 	}
	dashboard('#dashboard',versionData);
	$("#loadingBar").hide();
}).fail(function(jqXHR, textStatus, errorThrown) {
	
});

</script>
</body>
</html>
